@model Traeq.Models.SupportChatViewModel

@{
    ViewData["Title"] = "Support Chat";
}

<div class="bg-light py-3">
    <div class="container">
        <div class="row">
            <div class="col-md-12 mb-0">
                <a asp-action="Index" asp-controller="Home" asp-area="">Home</a>
                <span class="mx-2 mb-0">/</span>
                <a asp-action="@Model.BackAction" asp-controller="@Model.BackController" asp-area="">@Model.BackLabel</a>
                <span class="mx-2 mb-0">/</span>
                <strong class="text-black">@Model.Title</strong>
            </div>
        </div>
    </div>
</div>

<div class="site-section">
    <div class="container">
        <div class="row mb-3">
            <div class="col-md-12">
                <h3 class="text-black">Support Chat</h3>
                <p class="text-muted mb-1">@Model.SubTitle</p>
                @if (Model.IsClosed)
                {
                    <span class="badge bg-secondary">Conversation Closed</span>
                }
                else
                {
                    <span class="badge bg-success">Open</span>
                }
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="border rounded p-3 mb-3" style="max-height: 400px; overflow-y: auto; background-color:#f8f9fa;">
                    @if (Model.Messages != null && Model.Messages.Any())
                    {
                        foreach (var msg in Model.Messages)
                        {
                            var isUser = msg.SenderType == "User";
                            <div class="d-flex mb-2 @(isUser ? "justify-content-end" : "justify-content-start")">
                                <div class="p-2 rounded"
                                     style="max-width:70%; @(isUser ? "background-color:#90caf9;color:white;" : "background-color:white;border:1px solid #0d47a1;")">
                                    <div class="small text-muted mb-1">
                                        @msg.SenderLabel - @msg.SentAt.ToString("yyyy-MM-dd HH:mm")
                                    </div>
                                    <div>@msg.MessageText</div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted mb-0">No messages yet. Start by sending your message below.</p>
                    }
                </div>

                @if (!Model.IsClosed)
                {
                    <form asp-area="" asp-action="@Model.SendAction" asp-controller="Home" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="threadId" value="@Model.ThreadId" />
                        <div class="mb-3">
                            <label for="messageText" class="form-label">Your Message</label>
                            <textarea class="form-control" id="messageText" name="messageText" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </form>

                    <form asp-area="" asp-action="@Model.CloseAction" asp-controller="Home" method="post" class="mt-2">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="threadId" value="@Model.ThreadId" />
                        <button type="submit" class="btn btn-outline-danger btn-sm"
                                onclick="return confirm('Are you sure you want to end this conversation? You will not be able to send more messages.');">
                            End Conversation
                        </button>
                    </form>
                }
                else
                {
                    <p class="text-muted mt-2">
                        This conversation is closed. If you still have questions, you can start a new support request from the Contact Us page.
                    </p>
                }
            </div>
        </div>
    </div>
</div>

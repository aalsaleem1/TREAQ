@model Traeq.DTO.CheckoutViewModel

@{
    ViewData["Title"] = "Checkout";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
    .selection-card {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        background-color: #fff;
        display: flex;
        align-items: center;
    }

        .selection-card:hover {
            border-color: #4e73df;
            background-color: #f8f9fc;
            transform: translateY(-2px);
        }

        .selection-card.active {
            border-color: #4e73df;
            background-color: #f0f4ff;
            box-shadow: 0 0 10px rgba(78, 115, 223, 0.1);
        }

        .selection-card .form-check-input {
            cursor: pointer;
            transform: scale(1.2);
            margin-right: 15px;
        }

        .selection-card label {
            cursor: pointer;
            width: 100%;
            margin-bottom: 0;
            font-weight: 600;
            color: #5a5c69;
        }

    .section-title {
        color: #2e3440;
        font-weight: 700;
        margin-bottom: 20px;
        font-size: 1.1rem;
        border-bottom: 2px solid #eaecf4;
        padding-bottom: 10px;
    }

    #map {
        height: 300px;
        width: 100%;
        border-radius: 8px;
        margin-top: 15px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        z-index: 1;
    }
</style>

<div class="bg-light py-3">
    <div class="container">
        <div class="row">
            <div class="col-md-12 mb-0">
                <a asp-action="Index" asp-controller="Home" asp-area="">Home</a>
                <span class="mx-2 mb-0">/</span>
                <a asp-action="Index" asp-controller="Cart" asp-area="">Cart</a>
                <span class="mx-2 mb-0">/</span>
                <strong class="text-black">Checkout</strong>
            </div>
        </div>
    </div>
</div>

<div class="site-section">
    <div class="container">
        <form asp-action="Index" asp-controller="Checkout" asp-area="" method="post">
            <div class="row">
                <div class="col-md-7 mb-5 mb-md-0">
                    <div class="p-3 p-lg-5 border bg-white shadow-sm rounded">

                        <div class="mb-5">
                            <h3 class="section-title">1. Delivery Method</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="selection-card" onclick="selectRadio('methodDelivery'); toggleDelivery(true);">
                                        <input class="form-check-input" type="radio" asp-for="DeliveryMethod" value="Delivery" id="methodDelivery" checked>
                                        <label for="methodDelivery">
                                            <i class="fas fa-truck text-primary me-2"></i> Home Delivery
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="selection-card" onclick="selectRadio('methodPickup'); toggleDelivery(false);">
                                        <input class="form-check-input" type="radio" asp-for="DeliveryMethod" value="Pickup" id="methodPickup">
                                        <label for="methodPickup">
                                            <i class="fas fa-store text-success me-2"></i> Pickup from Pharmacy
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <span asp-validation-for="DeliveryMethod" class="text-danger"></span>
                        </div>

                        <div id="addressSection">
                            <h3 class="section-title">2. Shipping Address</h3>

                            @if (Model.ExistingAddresses.Any())
                            {
                                <div class="mb-3">
                                    @foreach (var addr in Model.ExistingAddresses)
                                    {
                                        <div class="selection-card" onclick="selectRadio('addr_@addr.Id'); toggleNewAddress(false);">
                                            <input class="form-check-input" type="radio" name="SelectedAddressId" value="@addr.Id" id="addr_@addr.Id">
                                            <label for="addr_@addr.Id">
                                                <div class="d-flex justify-content-between">
                                                    <span>@addr.City, @addr.District</span>
                                                </div>
                                                <small class="text-muted d-block fw-normal mt-1">@addr.FullAddress</small>
                                                <small class="text-muted d-block fw-normal"><i class="fas fa-phone-alt fa-xs"></i> @addr.PhoneNumber</small>
                                            </label>
                                        </div>
                                    }
                                </div>
                            }

                            <div class="selection-card" onclick="selectRadio('addr_new'); toggleNewAddress(true);">
                                <input class="form-check-input" type="radio" name="SelectedAddressId" value="" id="addr_new" @(!Model.ExistingAddresses.Any() ? "checked" : "")>
                                <label for="addr_new">
                                    <i class="fas fa-plus-circle text-primary me-2"></i> Add New Address
                                </label>
                            </div>

                            <div id="newAddressFields" class="p-4 border rounded bg-light mt-3" style="@(Model.ExistingAddresses.Any() ? "display:none;" : "")">

                                <input type="hidden" asp-for="NewLatitude" id="latInput" />
                                <input type="hidden" asp-for="NewLongitude" id="lngInput" />

                                <div class="alert alert-info small">
                                    <i class="fas fa-map-marker-alt"></i> You can type your address below AND select your exact location on the map.
                                </div>

                                <label class="small fw-bold text-secondary mb-1">Pin Location on Map (Optional)</label>
                                <div id="map"></div>

                                <div class="row mt-3">
                                    <div class="col-md-6 form-group mb-3">
                                        <label asp-for="NewCity" class="small fw-bold text-secondary mb-1">City <span class="text-danger">*</span></label>
                                        <input asp-for="NewCity" class="form-control" placeholder="Amman">
                                        <span asp-validation-for="NewCity" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6 form-group mb-3">
                                        <label asp-for="NewDistrict" class="small fw-bold text-secondary mb-1">District <span class="text-danger">*</span></label>
                                        <input asp-for="NewDistrict" class="form-control" placeholder="Jubaiha">
                                        <span asp-validation-for="NewDistrict" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="NewFullAddress" class="small fw-bold text-secondary mb-1">Full Address <span class="text-danger">*</span></label>
                                    <input asp-for="NewFullAddress" class="form-control" placeholder="Street name, Building No, Apartment...">
                                    <span asp-validation-for="NewFullAddress" class="text-danger"></span>
                                </div>

                                <div class="form-group">
                                    <label asp-for="NewPhoneNumber" class="small fw-bold text-secondary mb-1">Phone Number <span class="text-danger">*</span></label>
                                    <input asp-for="NewPhoneNumber" type="text" class="form-control" placeholder="079xxxxxxx">
                                    <span asp-validation-for="NewPhoneNumber" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="col-md-5">
                    <div class="p-3 p-lg-5 border bg-white shadow-sm rounded">
                        <h3 class="section-title">Your Order</h3>

                        <table class="table mb-4">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.CartItems)
                                {
                                    <tr>
                                        <td>@item.Medecine.MedicineName <span class="badge bg-secondary rounded-pill ms-1">x @item.Quantity</span></td>
                                        <td class="text-end">@item.TotalPrice.ToString("N2") JOD</td>
                                    </tr>
                                }
                                <tr>
                                    <td class="fw-bold">Subtotal</td>
                                    <td class="text-end">@Model.Subtotal.ToString("N2") JOD</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Discount</td>
                                    <td class="text-end text-success">-@Model.DiscountAmount.ToString("N2") JOD</td>
                                </tr>
                                <tr class="table-active">
                                    <td class="fw-bold">Order Total</td>
                                    <td class="fw-bold text-end text-black">@Model.TotalAmount.ToString("N2") JOD</td>
                                </tr>
                            </tbody>
                        </table>


                        <div class="mb-4">
                            <h3 class="section-title">3. Payment Method</h3>

                            <div class="selection-card" onclick="selectRadio('pay_cod');">
                                <input class="form-check-input" type="radio" asp-for="PaymentMethod" value="CashOnDelivery" id="pay_cod" checked>
                                <label for="pay_cod">
                                    <i class="fas fa-money-bill-wave text-success me-2"></i> Cash On Delivery
                                </label>
                            </div>

                            <div class="selection-card" onclick="selectRadio('pay_visa');">
                                <input class="form-check-input" type="radio" asp-for="PaymentMethod" value="Visa" id="pay_visa">
                                <label for="pay_visa">
                                    <i class="fab fa-cc-visa text-primary me-2"></i> Visa / MasterCard
                                </label>
                            </div>


                            <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg py-3 fw-bold shadow-sm">
                                Place Order
                            </button>
                            <a asp-action="Index" asp-controller="Cart" asp-area="" class="btn btn-outline-secondary py-2">
                                <i class="fas fa-arrow-left me-2"></i> Back to Cart
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        var map;
        var marker;

        $(document).ready(function() {
            updateCardStyles();
            if ($('#methodPickup').is(':checked')) {
                toggleDelivery(false);
            }

            if ($('#addr_new').is(':checked')) {
                 initMap();
            }
        });

        function toggleDelivery(isDelivery) {
            var section = $('#addressSection');
            if (isDelivery) {
                section.slideDown();
            } else {
                section.slideUp();
            }
        }

        function toggleNewAddress(showNew) {
            var fields = $('#newAddressFields');
            if (showNew) {
                fields.slideDown(400, function() {
                    if (!map) initMap();
                    else map.invalidateSize();
                });
            } else {
                fields.slideUp();
            }
        }

        function selectRadio(id) {
            $('#' + id).prop('checked', true);
            updateCardStyles();
        }

        function updateCardStyles() {
            $('.selection-card').removeClass('active');
            $('input[type="radio"]:checked').closest('.selection-card').addClass('active');
        }

        function initMap() {
            var defaultLat = 31.9539;
            var defaultLng = 35.9106;

            var currentLat = $('#latInput').val();
            var currentLng = $('#lngInput').val();

            if (currentLat && currentLng) {
                defaultLat = currentLat;
                defaultLng = currentLng;
            }

            map = L.map('map').setView([defaultLat, defaultLng], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);

            if (!currentLat) {
                $('#latInput').val(defaultLat);
                $('#lngInput').val(defaultLng);

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var userLat = position.coords.latitude;
                        var userLng = position.coords.longitude;

                        map.setView([userLat, userLng], 16);
                        marker.setLatLng([userLat, userLng]);

                        $('#latInput').val(userLat);
                        $('#lngInput').val(userLng);
                    });
                }
            }

            marker.on('dragend', function(e) {
                var position = marker.getLatLng();
                $('#latInput').val(position.lat);
                $('#lngInput').val(position.lng);
            });

            map.on('click', function(e) {
                marker.setLatLng(e.latlng);
                $('#latInput').val(e.latlng.lat);
                $('#lngInput').val(e.latlng.lng);
            });

            setTimeout(function(){ map.invalidateSize(); }, 200);
        }
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}